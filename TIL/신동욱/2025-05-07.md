## onnx -> hefí•˜ê¸°
### How?
- Hailo Dataflow Compilerë¥¼ ë‹¤ìš´ë°›ëŠ”ë‹¤
- https://hailo.ai/developer-zone/documentation/dataflow-compiler-v3-31-0/?sp_referrer=install/install.html ì´ ë§í¬ë¥¼ ë”°ë¼ê°„ë‹¤

### ê°€ìƒí™˜ê²½ ë§Œë“¤ ë•Œ
```shell
python -m venv venv
```
- ì´ë ‡ê²Œ ë§Œë“¤ì–´ì„œ pip install í•˜ë©´ ì•ˆëœë‹¤
- ã„¹ã…‡ ì‹œí‚¤ëŠ”ëŒ€ë¡œ í•´ì•¼ í•¨

### ì„¤ì¹˜ í›„ hailo -hë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ
```shell
(myenv) godputer@godputer:~/S12P31C203$ hailo -h
[info] First time Hailo Dataflow Compiler is being used. Checking system requirements... (this might take a few seconds)
[Error] Requirement python3-tk not found.
[Error] See full log: /home/godputer/S12P31C203/.install_logs/hailo_installation_log_2025.05.07T08:42:19.log
[Warning] CUDNN version should be 8.9 or higher, found 9.8.
Component                                Requirement                    Found                               
==========  ==========       ==========  ==========                                                         
OS                                       Ubuntu               Ubuntu                                        Required
Release     20.04                        22.04                                       Required               
Package     python3-tk                   X                    Required                                      
Package     graphviz                     V                    Required                                      
Package     libgraphviz-dev              V                    Required                                      
Package     python3.10-dev               V                    Required                                      
RAM(GB)     16                                                                       Required               
RAM(GB)     32                                                                       Recommended            
CPU-Arch                                              x86_64  x86_64                              Required  
CPU-flag                                              avx     V                      Required               
GPU-Driver                                            525     570       Recommended                         
CUDA                                                  11.8              Recommended                         
CUDNN                                                 8.9     9.8       Recommended                         
Var:CC                       unset                    unset             Required                            
Var:CXX                      unset                    unset             Required                            
Var:LD                       unset                    unset             Required                            
Var:AS                       unset                    unset             Required                            
Var:AR                       unset                    unset             Required                            
Var:LN                       unset                    unset             Required                            
Var:DUMP                     unset                    unset             Required                            
Var:CPY                      unset                    unset             Required                            
System requirements check failed (see table above for details). Continue? [Y/n]
[info] Current Time: 08:42:34, 05/07/25
[info] CPU: Architecture: x86_64, Model: 11th Gen Intel(R) Core(TM) i7-11600H @ 2.90GHz, Number Of Cores: 12, Utilization: 4.1%
[info] Memory: Total: 31GB, Available: 25GB
[info] System info: OS: Linux, Kernel: 6.8.0-58-generic
[info] Hailo DFC Version: 3.31.0
[info] HailoRT Version: Not Installed
[info] PCIe: No Hailo PCIe device was found
[info] Running `hailo -h`
usage: hailo [-h] [--version]
             {analyze-noise,compiler,params-csv,parser,profiler,optimize,tb,visualizer,tutorial,har,join,har-onnx-rt,runtime-profiler,dfc-studio,help} ...

Hailo Command Line Utility

positional arguments:
  {analyze-noise,compiler,params-csv,parser,profiler,optimize,tb,visualizer,tutorial,har,join,har-onnx-rt,runtime-profiler,dfc-studio,help}
                        Hailo utilities aimed to help with everything you need
    analyze-noise       Analyze network quantization noise
    compiler            Compile Hailo model to HEF binary files
    params-csv          Convert translated params to csv
    parser              Translate network to Hailo network
    profiler            Hailo models Profiler
    optimize            Optimize model
    tb                  Create Tensorboard summary for Tensorflow model
    visualizer          HAR visualization tool
    tutorial            Runs the tutorials in jupyter notebook
    har                 Query and extract information from Hailo Archive file
    join                Join two Hailo models to a single model
    har-onnx-rt         Generates ONNX-Runtime model including pre/post processing
    runtime-profiler    Hailo Runtime Profiler
    dfc-studio          Start DFC Studio
    help                Show the list of commands

options:
  -h, --help            show this help message and exit
  --version             show program's version number and exit
```

### ì´ê±° ì—†ë‹¤ê³  í•˜ë‹ˆê¹Œ ì¼ë‹¨ ì„¤ì¹˜í•˜ì
```shell
Package     python3-tk                   X                    Required                                      
```

- ì´ë ‡ê²Œ ì„¤ì¹˜í•˜ë©´ ë¨
```shell
sudo apt update
sudo apt install python3-tk
```

## ONNX -> Hailo ê³¼ì •
#### 1. Parsing (HAR íŒŒì¼ ìƒì„±)
#### 2. Optimization (ì–‘ìí™” ë° ìµœì í™”)
#### 3. Compilation (HEF íŒŒì¼ ìƒì„±)

### 1ë‹¨ê³„:Parsing - ONNX ëª¨ë¸ì„ HARë¡œ ë³€í™˜
ë¨¼ì €, ONNX ëª¨ë¸ì„ Hailoì˜ ë‚´ë¶€ í‘œí˜„ í˜•ì‹ì¸ HAR(Hailo Archive) íŒŒì¼ë¡œ ë³€í™˜í•´ì•¼ í•¨.

```bash
hailo parser onnx --input-files xx.onnx --output-har xx.har
```
- `xx.onnx`: ë³€í™˜í•˜ë ¤ëŠ” ONNX ëª¨ë¸ íŒŒì¼
- `xx.har`: ìƒì„±ë  HAR íŒŒì¼ì˜ ì´ë¦„

### 2ë‹¨ê³„: Optimization â€“ ì–‘ìí™” ë° ìµœì í™”
HAR íŒŒì¼ì„ ìƒì„±í•œ í›„, ì´ë¥¼ ìµœì í™”í•˜ì—¬ ì–‘ìí™”ëœ HAR íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
```bash
hailo optimize --input model.har --output model_optimized.har --use-random-calib-set
```
- `--use-random-calib-set`: ì„ì˜ì˜ ë°ì´í„°ì…‹ì„ ì‚¬ìš©í•˜ì—¬ ì–‘ìí™”ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì‹¤ì œ ë°ì´í„°ì…‹ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ì •í™•í•œ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 3ë‹¨ê³„: Compilation â€“ HEF íŒŒì¼ ìƒì„±
ìµœì í™”ëœ HAR íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ HEF íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
```bash
hailo compiler --input model_optimized.har --output model.hef
```
- `model.hef`: ìƒì„±ë  HEF íŒŒì¼ì˜ ì´ë¦„ì…ë‹ˆë‹¤.

ì´ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•  ê²½ìš°, ëª¨ë¸ì˜ êµ¬ì¡°ë‚˜ ì–‘ìí™” ì„¤ì •ì„ ë‹¤ì‹œ ê²€í† í•´ì•¼ í•©ë‹ˆë‹¤. íŠ¹íˆ, ë³µì¡í•œ ëª¨ë¸ì—ì„œëŠ” ì»´íŒŒì¼ ì‹œê°„ì´ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë©°, ì´ë¡œ ì¸í•´ íƒ€ì„ì•„ì›ƒ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


## 1ë‹¨ê³„ì—ì„œ ì‚½ì§ˆ
```bash
hailo parser onnx --input-files xx.onnx --output-har xx.har
```

- ì´ê±° ì‹¤í–‰í•˜ë©´ íŒŒì‹± ì˜¤ë¥˜ ë°œìƒ
- ì´ìœ ëŠ” paddleì—ì„œ onnxëª¨ë¸ë¡œ ë³€í™˜í•  ë•Œ ë­”ê°€ ì˜¤ë¥˜ê°€ ìˆê¸° ë•Œë¬¸

### ì¼ë‹¨ onnx ëª¨ë¸ ì…ë ¥ê³¼ ì¶œë ¥ ì´ë¦„ì„ ì˜ ì„¤ì •í•´ë³´ì
- onnx ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©í•´ì„œ ì´ë¦„ ì˜ ë°”ê¿€ ìˆ˜ ìˆìŒ
- netronìœ¼ë¡œ ë³€ê²½ì‚¬í•­ë“¤ ê·¸ë¦¼ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥

![alt text](./images/2025-05-07-1.png)

- ì…ë ¥ ì´ë¦„ë„ xê°€ ì•„ë‹ˆë¼ ë‹¤ë¥¸ê±¸ë¡œ ë°”ê¿”ë³´ì

![alt text](./images/2025-05-07-2.png)

- ì¼ë‹¨ ë˜ê¸´ í•¨
- ë‹¤ì‹œ í•´ë³´ì ì´ë¦„ ì§€ì •í•´ì„œ

### ì ê¹ì ê¹. paddleì—ì„œ onnxë¡œ ë³€í™˜í•  ë•Œ ë™ì  shapeë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ
- ê·¸ë˜ì„œ ë™ì  shapeë¼ì„œ hailoê°€ ëª» í•˜ëŠ” ê±°
- ì´ê±¸ ì •ì ìœ¼ë¡œ ë°”ê¿”ì•¼ í•¨

- ê·¼ë° paddle ëª…ë ¹ì–´ì—ì„œ ì•ˆë˜ëŠ”ë°?
- onnxì—ì„œ ê·¸ëƒ¥ ê°•ì œ ìˆ˜ì •í•´ë²„ë¦¬ê¸° í•´ë³´ì
``` py
import onnx
from onnx import helper, TensorProto

model = onnx.load("mobilefacenet.onnx")

# ğŸ”§ ì…ë ¥ ì´ë¦„ ìˆ˜ì •
old_input_name = model.graph.input[0].name
model.graph.input[0].name = "input_image"

for node in model.graph.node:
    for i, name in enumerate(node.input):
        if name == old_input_name:
            node.input[i] = "input_image"

# ğŸ”§ ì¶œë ¥ ì´ë¦„ ìˆ˜ì •
old_output_name = model.graph.output[0].name
model.graph.output[0].name = "embedding"

for node in model.graph.node:
    for i, name in enumerate(node.output):
        if name == old_output_name:
            node.output[i] = "embedding"

# ğŸ”§ ì…ë ¥ shape ê³ ì •
model.graph.input[0].type.tensor_type.shape.dim[0].dim_value = 1
model.graph.input[0].type.tensor_type.shape.dim[1].dim_value = 3
model.graph.input[0].type.tensor_type.shape.dim[2].dim_value = 112
model.graph.input[0].type.tensor_type.shape.dim[3].dim_value = 112

# ğŸ”§ ì¶œë ¥ shape ê³ ì •
model.graph.output[0].type.tensor_type.shape.dim[0].dim_value = 1
model.graph.output[0].type.tensor_type.shape.dim[1].dim_value = 128

# ì €ì¥
onnx.save(model, "mobilefacenet_final.onnx")
```
### ì•ˆëœë‹¤ ê·¸ëƒ¥ batchnormalizationê¹Œì§€ íŒŒì‹±í•˜ê³  í›„ì²˜ë¦¬ë¡œ 128ì°¨ì› ë½‘ì
- ì•„. ì¼ë‹¨ ì•ˆë˜ëŠ”ë° ëœë‹¤ ì³ë„ ëª¨ë¸ì˜ ë°ì´í„°ì…‹ì„ ë§¥ì—¬ì„œ ë³€í™˜í•´ì•¼ í•¨

## ì tappasì— ìˆëŠ” ì˜ˆì œ ëŒë ¤ë³´ëŠ”ê±¸ë¡œ ì „í™˜

